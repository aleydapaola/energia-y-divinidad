// Prisma Schema para Energía y Divinidad
// Arquitectura: Bounded Contexts + Entitlements para acceso a contenido

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// BOUNDED CONTEXT: User Management
// ============================================

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String? // Para autenticación con email/password
  role          UserRole  @default(USER)

  // Relaciones
  accounts         Account[]
  sessions         Session[]
  orders           Order[]
  subscriptions    Subscription[]
  entitlements     Entitlement[]
  bookings         Booking[]
  sessionPackCodes SessionPackCode[]
  postLikes        MembershipPostLike[]
  postComments     MembershipPostComment[]
  commentLikes     CommentLike[]
  pollVotes        PollVote[]
  postViews        MembershipPostView[]
  courseProgress   CourseProgress[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// NextAuth - Account (para OAuth providers)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth - Session
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// NextAuth - Verification Token
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// BOUNDED CONTEXT: Payments & Orders
// ============================================

enum PaymentMethod {
  // Wompi (Colombia - COP)
  WOMPI_NEQUI
  WOMPI_CARD
  WOMPI_PSE

  // ePayco (Internacional - USD y COP)
  EPAYCO_CARD
  EPAYCO_PAYPAL
  EPAYCO_PSE

  // Gratis (descuento 100%)
  FREE

  // Legacy (mantener para migraciones)
  STRIPE
  NEQUI
  MANUAL_NEQUI
  MANUAL_DAVIPLATA
  MANUAL_BANCOLOMBIA
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum OrderType {
  PRODUCT
  SESSION
  EVENT
  MEMBERSHIP
  PREMIUM_CONTENT
  COURSE
}

model Order {
  id          String  @id @default(cuid())
  userId      String?
  orderNumber String  @unique // Generado: ORD-YYYYMMDD-XXXX

  // Guest checkout - email cuando no hay usuario autenticado
  guestEmail String?
  guestName  String?

  // Tipo y referencia
  orderType OrderType
  itemId    String // ID del producto/sesión/evento en Sanity o ID de membership tier
  itemName  String

  // Montos
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("COP") // COP o USD

  // Descuentos (opcional)
  discountCodeId String?  // Sanity _id del código de descuento
  discountCode   String?  // Código usado (para histórico)
  discountAmount Decimal? @db.Decimal(10, 2) // Monto descontado
  originalAmount Decimal? @db.Decimal(10, 2) // Monto original antes del descuento

  // Pago
  paymentMethod PaymentMethod
  paymentStatus PaymentStatus @default(PENDING)

  // Metadata adicional (JSON para datos específicos de pasarela)
  metadata Json?

  // Relaciones
  user          User?          @relation(fields: [userId], references: [id])
  manualPayment ManualPayment?
  stripePayment StripePayment?
  entitlements  Entitlement[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("orders")
}

// Pagos manuales (Nequi, Daviplata, Bancolombia)
model ManualPayment {
  id      String @id @default(cuid())
  orderId String @unique

  // Detalles del pago
  paymentMethod   PaymentMethod
  referenceNumber String? // Número de transacción proporcionado por el usuario
  screenshot      String? // URL del screenshot de comprobante

  // Aprobación manual
  approved       Boolean   @default(false)
  approvedAt     DateTime?
  approvedBy     String? // Admin user ID
  rejectedReason String?

  // Relaciones
  order Order @relation(fields: [orderId], references: [id])

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("manual_payments")
}

// Pagos con Stripe
model StripePayment {
  id      String @id @default(cuid())
  orderId String @unique

  // IDs de Stripe
  stripePaymentIntentId String  @unique
  stripeCustomerId      String?

  // Detalles
  amount   Decimal @db.Decimal(10, 2)
  currency String
  status   String // Stripe payment intent status

  // Webhook idempotency
  webhookProcessed Boolean @default(false)
  webhookId        String? @unique

  // Relaciones
  order Order @relation(fields: [orderId], references: [id])

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stripe_payments")
}

// ============================================
// BOUNDED CONTEXT: Memberships
// ============================================

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
  TRIAL
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

model Subscription {
  id     String @id @default(cuid())
  userId String

  // Membership tier (referencia a Sanity)
  membershipTierId   String // ID del documento en Sanity
  membershipTierName String

  // Billing
  status          SubscriptionStatus
  billingInterval BillingInterval
  amount          Decimal            @db.Decimal(10, 2)
  currency        String             @default("COP")
  paymentProvider String             @default("stripe") // "stripe" | "nequi" | "manual"

  // Stripe (si aplica)
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?

  // Nequi (si aplica)
  nequiSubscriptionId String? @unique // ID de suscripción de Nequi API
  nequiPhoneNumber    String? // Número de celular registrado en Nequi
  nequiApprovedAt     DateTime? // Cuando el usuario aprobó en la app Nequi

  // Fechas
  startDate          DateTime
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  trialEnd           DateTime?
  cancelledAt        DateTime?

  // Relaciones
  user         User          @relation(fields: [userId], references: [id])
  entitlements Entitlement[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscriptions")
}

// ============================================
// BOUNDED CONTEXT: Entitlements (Access Control)
// ============================================

enum EntitlementType {
  MEMBERSHIP // Acceso a membresía
  PREMIUM_CONTENT // Acceso a contenido premium específico
  EVENT // Acceso a evento
  SESSION_BUNDLE // Paquete de sesiones
  PRODUCT // Producto digital comprado
  COURSE // Curso de la academia
}

model Entitlement {
  id     String @id @default(cuid())
  userId String

  // Tipo y referencia
  type         EntitlementType
  resourceId   String // ID en Sanity del recurso
  resourceName String

  // Orden relacionada
  orderId        String?
  subscriptionId String?

  // Validez
  expiresAt     DateTime? // null = permanente
  revoked       Boolean   @default(false)
  revokedAt     DateTime?
  revokedReason String?

  // Para session bundles
  sessionsTotal Int? // Total de sesiones en el paquete
  sessionsUsed  Int? @default(0)

  // Relaciones
  user         User          @relation(fields: [userId], references: [id])
  order        Order?        @relation(fields: [orderId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, type])
  @@index([userId, resourceId])
  @@map("entitlements")
}

// ============================================
// BOUNDED CONTEXT: Bookings (Sesiones y Eventos)
// ============================================

enum BookingType {
  SESSION_1_ON_1
  EVENT
}

enum BookingStatus {
  PENDING_PAYMENT // Esperando pago
  PENDING // Esperando confirmación
  CONFIRMED // Confirmada
  CANCELLED // Cancelada por usuario
  COMPLETED // Completada
  NO_SHOW // Usuario no apareció
}

model Booking {
  id     String @id @default(cuid())
  userId String

  // Tipo y referencia
  bookingType  BookingType
  resourceId   String // ID en Sanity (session o event)
  resourceName String

  // Fecha y hora
  scheduledAt DateTime?
  duration    Int? // Duración en minutos

  // Status
  status BookingStatus @default(PENDING)

  // Payment info
  amount        Decimal?       @db.Decimal(10, 2)
  currency      String?        @default("COP")
  paymentMethod PaymentMethod?
  paymentStatus PaymentStatus? @default(PENDING)

  // Session pack info
  sessionsTotal     Int? // Total de sesiones en el paquete
  sessionsRemaining Int? // Sesiones restantes

  // Stripe payment (if applicable)
  stripeSessionId String? @unique

  // Nequi payment (if applicable)
  nequiTransactionCode String? // Código único de transacción
  nequiQrCode          String? @db.Text // QR code para pago (modo gateway)
  nequiPaymentId       String? // ID de pago de Nequi API

  // Entitlement (si fue pagado)
  entitlementId String?

  // Formulario de ingreso (para sesiones 1:1)
  intakeFormData Json? // Respuestas del formulario

  // Notas
  userNotes  String? @db.Text
  adminNotes String? @db.Text

  // Cancelación
  cancelledAt        DateTime?
  cancellationReason String?

  // Reprogramación
  previousScheduledAt DateTime? // Fecha anterior (antes de reprogramar)
  rescheduledAt       DateTime? // Cuándo se reprogramó
  rescheduledBy       String?   // userId de quien reprogramó (null = cliente, id = admin)
  rescheduleCount     Int       @default(0) // Veces que se ha reprogramado
  rescheduleReason    String?   // Motivo de la última reprogramación

  // Relaciones
  user User @relation(fields: [userId], references: [id])

  // Metadata adicional
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([scheduledAt])
  @@map("bookings")
}

// ============================================
// BOUNDED CONTEXT: Session Pack Codes
// ============================================

model SessionPackCode {
  id     String @id @default(cuid())
  userId String

  // Código único para canjear sesiones
  code String @unique // Formato: PACK-XXXXXX

  // Info del pack
  packName        String  @default("Pack de 8 Sesiones")
  sessionsTotal   Int     @default(8)
  sessionsUsed    Int     @default(0)
  priceAtPurchase Decimal @db.Decimal(10, 2)
  currency        String  @default("COP")

  // Estado
  active    Boolean   @default(true)
  expiresAt DateTime? // null = no expira

  // Booking relacionado (la compra original)
  originalBookingId String? @unique

  // Relaciones
  user            User              @relation(fields: [userId], references: [id])
  redemptions     PackRedemption[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([code])
  @@map("session_pack_codes")
}

model PackRedemption {
  id        String @id @default(cuid())
  packCodeId String
  bookingId  String @unique

  // Relaciones
  packCode SessionPackCode @relation(fields: [packCodeId], references: [id])

  // Metadata
  redeemedAt DateTime @default(now())

  @@index([packCodeId])
  @@map("pack_redemptions")
}

// ============================================
// BOUNDED CONTEXT: Membership Posts (Engagement)
// ============================================

// Modelo para tracking de publicaciones de membresía (sincronizado con Sanity)
model MembershipPost {
  id       String @id @default(cuid())
  sanityId String @unique // _id del documento en Sanity
  slug     String @unique

  // Engagement
  likes     MembershipPostLike[]
  comments  MembershipPostComment[]
  views     MembershipPostView[]
  pollVotes PollVote[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sanityId])
  @@index([slug])
  @@map("membership_posts")
}

// Likes en publicaciones de membresía
model MembershipPostLike {
  id     String @id @default(cuid())
  userId String
  postId String

  // Relaciones
  user User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  post MembershipPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([postId])
  @@map("membership_post_likes")
}

// Comentarios en publicaciones de membresía
model MembershipPostComment {
  id      String @id @default(cuid())
  userId  String
  postId  String
  content String @db.Text

  // Relaciones
  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  post  MembershipPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  likes CommentLike[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([userId])
  @@map("membership_post_comments")
}

// Likes en comentarios
model CommentLike {
  id        String @id @default(cuid())
  userId    String
  commentId String

  // Relaciones
  user    User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment MembershipPostComment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt DateTime @default(now())

  @@unique([userId, commentId])
  @@index([commentId])
  @@map("comment_likes")
}

// Votos en encuestas
model PollVote {
  id          String @id @default(cuid())
  userId      String
  postId      String
  optionIndex Int // Índice de la opción votada en el array pollOptions

  // Relaciones
  user User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  post MembershipPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt DateTime @default(now())

  @@unique([userId, postId]) // Un usuario solo puede votar una vez por encuesta
  @@index([postId])
  @@map("poll_votes")
}

// Vistas de publicaciones (para analytics)
model MembershipPostView {
  id     String  @id @default(cuid())
  userId String? // Puede ser null si es vista anónima
  postId String

  // Relaciones
  user User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  post MembershipPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Metadata
  createdAt DateTime @default(now())

  @@index([postId])
  @@index([userId])
  @@map("membership_post_views")
}

// ============================================
// BOUNDED CONTEXT: Webhooks (Idempotency)
// ============================================

model WebhookEvent {
  id String @id @default(cuid())

  // Proveedor
  provider  String // "stripe", "other"
  eventId   String @unique // ID del webhook del proveedor
  eventType String // Tipo de evento

  // Procesamiento
  processed   Boolean   @default(false)
  processedAt DateTime?

  // Payload
  payload Json

  // Error handling
  failed       Boolean @default(false)
  errorMessage String? @db.Text
  retryCount   Int     @default(0)

  // Metadata
  createdAt DateTime @default(now())

  @@index([provider, eventId])
  @@map("webhook_events")
}

// ============================================
// BOUNDED CONTEXT: Academia (Courses)
// ============================================

// Tracking de uso de códigos de descuento (el código está en Sanity)
model DiscountUsage {
  id             String   @id @default(cuid())
  discountCodeId String   // Sanity _id del código
  discountCode   String   // Código usado (para histórico)
  userId         String
  orderId        String
  discountAmount Decimal  @db.Decimal(10, 2)
  currency       String
  usedAt         DateTime @default(now())

  @@unique([discountCodeId, orderId])
  @@index([userId])
  @@index([discountCodeId])
  @@map("discount_usages")
}

// Progreso del usuario en un curso
model CourseProgress {
  id                   String           @id @default(cuid())
  userId               String
  courseId             String           // Sanity course _id
  startedAt            DateTime         @default(now())
  completedAt          DateTime?
  lastAccessedAt       DateTime         @default(now())
  completionPercentage Decimal          @db.Decimal(5, 2) @default(0)

  // Relaciones
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("course_progress")
}

// Progreso del usuario en una lección específica
model LessonProgress {
  id               String  @id @default(cuid())
  courseProgressId String
  lessonId         String  // Sanity lesson _id
  completed        Boolean @default(false)
  completedAt      DateTime?
  watchedSeconds   Int     @default(0) // Segundos de video vistos
  lastPosition     Int     @default(0) // Posición de reproducción para continuar

  // Relaciones
  courseProgress CourseProgress @relation(fields: [courseProgressId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseProgressId, lessonId])
  @@index([courseProgressId])
  @@map("lesson_progress")
}
